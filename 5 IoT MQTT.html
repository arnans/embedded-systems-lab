<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>การสื่อสารกับสมองกลฝังตัวผ่าน MQTT</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">การสื่อสารกับสมองกลฝังตัวผ่าน MQTT</h1>
</header>
<section data-field="subtitle" class="p-summary">
ในปฏิบัติการนี้จะแสดงให้วิธีการใช้ MQTT ในการสื่อสารระหว่างระบบสมองกลฝังตัว และ Web Application ดังรายละเอียดต่อไปนี้
</section>
<section data-field="body" class="e-content">
<section name="912b" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="e4fa" id="e4fa" class="graf graf--h3 graf--leading graf--title">การสื่อสารกับสมองกลฝังตัวผ่าน MQTT</h3><p name="5db8" id="5db8" class="graf graf--p graf-after--h3">ในปฏิบัติการนี้จะแสดงให้วิธีการใช้ MQTT ในการสื่อสารระหว่างระบบสมองกลฝังตัว และ Web Application ดังรายละเอียดต่อไปนี้</p><ol class="postList"><li name="4bbc" id="4bbc" class="graf graf--li graf-after--p"><a href="#4591" data-href="#4591" class="markup--anchor markup--li-anchor">ศึกษาหลักการทำงานของ MQTT</a></li><li name="e8c2" id="e8c2" class="graf graf--li graf-after--li"><a href="#eeed" data-href="#eeed" class="markup--anchor markup--li-anchor">ฝึกต่อ ESP32 เข้ากับระบบเครือข่าย</a></li><li name="6607" id="6607" class="graf graf--li graf-after--li"><a href="#756b" data-href="#756b" class="markup--anchor markup--li-anchor">ฝึกเขียนโปรแกรมสมองกลฝังตัวเพื่อรับและส่งค่าผ่าน MQTT</a></li><li name="103f" id="103f" class="graf graf--li graf-after--li"><a href="#f689" data-href="#f689" class="markup--anchor markup--li-anchor">ฝึกสร้าง Dashboard ที่ใช้แสดงค่า และควบคุมการทำงานของสมองกล</a></li></ol><h3 name="4591" id="4591" class="graf graf--h3 graf-after--li">1. ทดลองศึกษาการทำงานของ MQTT</h3><figure name="ccfc" id="ccfc" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*lpZg76ssY953KU38.png" data-width="500" data-height="335" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*lpZg76ssY953KU38.png"><figcaption class="imageCaption">ภาพแสดงโครงสร้างพื้นฐานของการสื่อสารด้วย MQTT</figcaption></figure><h3 name="17e8" id="17e8" class="graf graf--h3 graf-after--figure">หลักการของ MQTT Broker, การ publish และ การ Subscribe</h3><p name="87da" id="87da" class="graf graf--p graf-after--h3">MQTT (Message Queuing Telemetry Transport) เป็นแนวทางการสื่อสารระหว่างอุปกรณ์ที่ได้รับความนิยมอย่างสูงโดยเฉพาะกับงานด้าน IoT (Internet of Things) ที่ส่วนประกอบสำคัญคือ</p><ol class="postList"><li name="463d" id="463d" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">MQTT Broker </strong>— ทำให้ที่เป็น server ตัวกลางในการรับส่งข้อมูลระหว่างต้นทางกับปลายทาง</li><li name="4eb2" id="4eb2" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Publisher </strong>— คืออุปกรณ์ที่ส่งค่าผ่านทาง MQTT</li><li name="72df" id="72df" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Subscriber </strong>— คืออุปกรณ์ที่รับค่าจาก MQTT</li></ol><p name="06c4" id="06c4" class="graf graf--p graf-after--li">เช่น หากต้องการเฝ้าติดตามระดับฝุ่นควัน PM2.5 ในเมือง โดยมีเซ็นเซอร์กระจายอยู่ตามจุดต่างๆ ของเมืองนั้น สมองกลที่ต่ออยู่กับเซ็นเซอร์จะทำหน้าที่เป็น Publisher ทำการ publish ค่าฝุ่นที่วัดได้ไปยัง MQTT Broker โดยหากต้องการบันทึกข้อมูลนี้ลงฐานข้อมูล เครื่องคอมพิวเตอร์ที่ต่อฐานข้อมูลอยู่ก็จะ Subscribe ค่านี้จาก MQTT Broker เพื่อให้ Broker ส่งต่อข้อมูลให้ทุกครั้งที่เซ็นเซอร์ส่งค่ามา เป็นต้น</p><p name="3359" id="3359" class="graf graf--p graf-after--p">หมายเหตุ อุปกรณ์หนึ่ง ๆ อาจเป็นทั้ง Publisher และ Subscriber ก็ได้ เช่น หากเซ็นเซอร์วันฝุ่นมีการต่อสัญญาณไฟเตือนภัยไว้ด้วย คอมพิวเตอร์ศูนย์กลางก็สามารถ publish คำสั่งให้เปิดไฟเตือน โดยระบบสมองกลก็จะ subscribe เพื่อรับคำสั่งนั้น เป็นต้น</p><p name="6e56" id="6e56" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">MQTT Topic</strong></p><p name="9efd" id="9efd" class="graf graf--p graf-after--p">การรับ-ส่งค่าผ่าน MQTT Broker จะทำผ่าน Topic ซึ่งสามารถแบ่งลำดับขั้นของหัวข้อได้ตามรูปแบบต่อไปนี้</p><blockquote name="bf8b" id="bf8b" class="graf graf--pullquote graf-after--p">topic/sub-topic1/sub-topic2/…</blockquote><p name="da06" id="da06" class="graf graf--p graf-after--pullquote">หัวข้อแต่ละระดับจะถูกแบ่งด้วยเครื่องหมาย “/” เช่น ตัวอย่างฝุ่น PM2.5 ข้างต้นอาจ publish ไปยังหัวข้อที่ชื่อ</p><blockquote name="8c4e" id="8c4e" class="graf graf--pullquote graf-after--p">pm25/node1</blockquote><p name="e188" id="e188" class="graf graf--p graf-after--pullquote">โดยคอมพิวเตอร์ที่รับค่านี้ก็จะต้อง Subscribe หัวข้อเดียวกันนี้ด้วย โดยหากมีหลายหัวข้อในระดับเดียวกันก็สามารถใช้สัญลักษณ # เพื่อ subscribe ทุกหัวข้อในระดับนั้น ๆ ได้เช่น</p><blockquote name="0cf4" id="0cf4" class="graf graf--pullquote graf-after--p">pm25/#</blockquote><p name="d77b" id="d77b" class="graf graf--p graf-after--pullquote">หากในระบบมีเซ็นเซอร์หลายโหนด เครื่องรับก็จะได้รับค่าจากทุกโหนด ขอเพียงให้แต่ละโหนดส่งมาใต้ Topic ที่ชื่อ pm25/</p><h3 name="1ae1" id="1ae1" class="graf graf--h3 graf-after--p">การทดลอง</h3><figure name="273b" id="273b" class="graf graf--figure graf--iframe graf-after--h3"><iframe src="https://www.youtube.com/embed/5aGjZjNFfmk?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">การทดลอง 1 เชื่อม Web Client เข้ากับ MQTT Server</figcaption></figure><p name="bd96" id="bd96" class="graf graf--p graf-after--figure">ให้จับคู่กับเพื่อน หรือใช้สองอุปกรณ์ในการส่งข้อความหากันผ่าน MQTT</p><figure name="3fee" id="3fee" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*9DROx_vKFNKQbm6lCZFjzw.png" data-width="1193" data-height="450" src="https://cdn-images-1.medium.com/max/800/1*9DROx_vKFNKQbm6lCZFjzw.png"><figcaption class="imageCaption">ภาพแสดงการเชื่อมต่อ MQTT Broker โดยใช้ Web Client</figcaption></figure><ul class="postList"><li name="d1a1" id="d1a1" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">MQTT Web Client </strong>— เราจะใช้ MQTT Client ที่ชื่อ HiveMQ เพื่อทดลองรับ-ส่งข้อมูล<br><a href="http://www.hivemq.com/demos/websocket-client/" data-href="http://www.hivemq.com/demos/websocket-client/" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">http://www.hivemq.com/demos/websocket-client/</a></li><li name="b1a3" id="b1a3" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">MQTT Server </strong>— ใน HiveMQ ให้กรอกข้อมูล MQTT Broker ดังนี้<br>Server: test.mosquitto.org<br>Port: 8081 <br>SSL: Yes<br>Username/Password: ไม่ใช้<br>ClientID: ใช้ค่า default ที่ระบบกำหนดให้ ค่านี้ใช้ระบุ Client มีค่าเป็นอะไรก็ได้ โดยแต่ละ user จะต้องไม่ซ้ำกัน</li></ul><p name="e629" id="e629" class="graf graf--p graf-after--li">test.mosquitto.org เป็น Public Broker สามารถเข้าใช้ได้ฟรี และไม่ต้องระบุตัวตน เหมาะกับการทดลองและทดสอบ แต่ในกรณีที่จะใช้งานจริง แนะนำให้เปิดบริการ MQTT Broker ของตนเอง (เช่น Mosquitto ซึ่งเป็น MQTT Server ที่นิยมสูงตัวหนึ่ง) โดยการติดตั้งในเครื่องของตน หรือหาใช้ Cloud Service</p><h3 name="9434" id="9434" class="graf graf--h3 graf-after--p">ทดลอง subscribe topic</h3><p name="5cbe" id="5cbe" class="graf graf--p graf-after--h3">ใน Web Client ให้ลอง subscribe topic ที่กำหนดขึ้น เช่น group1/# เพื่อรับข้อความใด ๆ ที่ส่งมายัง topic “group1”</p><figure name="a2b7" id="a2b7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Oc42bp9h2e1H8KZ4XYTxJg.png" data-width="395" data-height="272" src="https://cdn-images-1.medium.com/max/800/1*Oc42bp9h2e1H8KZ4XYTxJg.png"><figcaption class="imageCaption">แสดงตัวอย่างการ subscribe</figcaption></figure><h3 name="231e" id="231e" class="graf graf--h3 graf-after--figure">ทดลอง publish ไปยัง topic</h3><p name="4332" id="4332" class="graf graf--p graf-after--h3">ใน Web Client ให้ลอง publish ค่าไปยัง topic ที่ subscribe ไว้ข้างต้น</p><figure name="ad8a" id="ad8a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*VzOgoqhtsXY6cZ8oh_sYvA.png" data-width="1197" data-height="537" src="https://cdn-images-1.medium.com/max/800/1*VzOgoqhtsXY6cZ8oh_sYvA.png"><figcaption class="imageCaption">แสดงตัวอย่างการ publish หาตัวเอง</figcaption></figure><p name="5bab" id="5bab" class="graf graf--p graf-after--figure">ในภาพแสดงการ Publish ไปยัง topic “group1/command” โดยมี payload คือคำว่า “on” และเนื่องจากมีการ subscribe topic “group1/#” ค่าที่ publish จึงแสดงในส่วนของ Messages ด้านล่างด้วย</p><h3 name="114f" id="114f" class="graf graf--h3 graf-after--p">โจทย์</h3><ul class="postList"><li name="0708" id="0708" class="graf graf--li graf-after--h3">ให้ใช้วิธีข้างต้นสร้าง Group Chat โดยให้หลาย ๆ คน (หรือหลาย ๆ device) ส่งข้อความเข้ามาใน Topic เดียวกัน</li></ul><h3 name="b945" id="b945" class="graf graf--h3 graf-after--li">ประเด็นการเรียนรู้</h3><ul class="postList"><li name="8a7a" id="8a7a" class="graf graf--li graf-after--h3">เข้าใจหลักการ publish และ subscribe</li><li name="dadb" id="dadb" class="graf graf--li graf-after--li">เห็นข้อดีของการสื่อสารแบบนี้ — ทำไมเราไม่ส่งข้อมูลตรงจากต้นทางไปยังปลายทางเลย ทำไมต้องใช้ตัวกลาง วิธีนี้มีข้อดีอย่างไร ทำไมจึงนิยมใช้</li><li name="582a" id="582a" class="graf graf--li graf-after--li">MQTT Client มีหลายหลายรูปแบบให้ใช้ — มีทั้งโปรแกรมสำเร็จรูป และมีทั้ง code library</li><li name="189b" id="189b" class="graf graf--li graf-after--li graf--trailing">MQTT Server มีหลายรูปแบบเช่นกัน — สามารถใช้ Public Broker เช่นข้างต้นเพื่อทดสอบ แต่ถ้าจะใช้กับงานจริง ๆ ควรตั้ง server เอง หรือใช้บริการบน cloud</li></ul></div></div></section><section name="89f6" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="eeed" id="eeed" class="graf graf--h3 graf--leading">2. การต่อ ESP32 เข้ากับระบบเครือข่าย</h3><figure name="3321" id="3321" class="graf graf--figure graf--iframe graf-after--h3"><iframe src="https://www.youtube.com/embed/DfKreqLxmOs?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">การทดลอง 2 เชื่อมต่อ ESP32 เข้ากับ Wifi</figcaption></figure><p name="7e05" id="7e05" class="graf graf--p graf-after--figure">ESP32 มี Wifi ในตัว ซึ่งสามารถเขียนโปรแกรมเพื่อต่อเข้ากับ Access Point ได้โดยง่ายดังโปรแกรมตัวอย่างต่อไปนี้</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="cpp" name="608c" id="608c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;WiFi.h&gt;</span></span><br /><br /><span class="hljs-comment">// Set to your network SSID/Password</span><br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> ssid[] = <span class="hljs-string">&quot;SSID&quot;</span>;<br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> pass[] = <span class="hljs-string">&quot;Wifi Password&quot;</span>;<br /><br />WiFiClient net;  <span class="hljs-comment">// creat the wifi object</span><br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span>{<br />  Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;checking wifi...&quot;</span>);<br />  <span class="hljs-keyword">while</span> (WiFi.<span class="hljs-built_in">status</span>() != WL_CONNECTED) {<br />    Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;.&quot;</span>);<br />    <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>);<br />  }<br /><br />  Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;\nwifi connected!&quot;</span>);<br />}<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<br />  Serial.<span class="hljs-built_in">begin</span>(<span class="hljs-number">9600</span>);<br />  WiFi.<span class="hljs-built_in">begin</span>(ssid, pass);<br /><br />  <span class="hljs-built_in">connect</span>();<br />}<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<br /><span class="hljs-comment">// Your main code goes here</span><br />}</span></pre><p name="6c40" id="6c40" class="graf graf--p graf-after--pre">การใช้งาน Code ข้างต้นจะต้องรู้ SSID และ Password ของ Wifi ที่ประสงค์ใช้ ซึ่ง Wifi ในองค์กรเช่นมหาวิทยาลัย มักต้องมีการ login ด้วยบัญชีผู้ใช้ก่อนเสมอ จะไม่สามารถใช้งานกับ ESP32 ด้วยวิธีข้างต้นได้ ทางแก้ไขคือ</p><ol class="postList"><li name="a039" id="a039" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">ปล่อย wifi จากโทรศัพท์</strong> — มักเป็นวิธีที่ง่ายที่สุดสำหรับการทดลอง แต่อาจไม่เหมาะกับการใช้งานจริง</li></ol><p name="b16f" id="b16f" class="graf graf--p graf-after--li">2. <strong class="markup--strong markup--p-strong">ใช้ wifi สำหรับอุปกรณ์ IoT</strong> — มหาวิทยาลัยเชียงใหม่มี wifi ชื่อ @JumboPlusIoT ให้ใช้งาน โดยนักศึกษาจะต้องลงทะเบียน<a href="https://randomnerdtutorials.com/get-change-esp32-esp8266-mac-address-arduino/" data-href="https://randomnerdtutorials.com/get-change-esp32-esp8266-mac-address-arduino/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">รหัส MAC Address </a>ของอุปกรณ์ และกำหนด wifi password ก่อน จาก Web Site ต่อไปนี้</p><p name="821e" id="821e" class="graf graf--p graf-after--p"><a href="https://jumbo-iot.cmu.ac.th/" data-href="https://jumbo-iot.cmu.ac.th/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://jumbo-iot.cmu.ac.th/</a></p><p name="a47b" id="a47b" class="graf graf--p graf-after--p">รหัส MAC Address ของ ESP32 สามารถเขียนโปรแกรมอ่านออกมาได้ตาม<a href="https://randomnerdtutorials.com/get-change-esp32-esp8266-mac-address-arduino/" data-href="https://randomnerdtutorials.com/get-change-esp32-esp8266-mac-address-arduino/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ตัวอย่างใน link นี้</a></p><figure name="2e05" id="2e05" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*A03Yie_cU12EIVXcmY0saw.png" data-width="775" data-height="818" src="https://cdn-images-1.medium.com/max/800/1*A03Yie_cU12EIVXcmY0saw.png"></figure></div></div></section><section name="9fa3" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="756b" id="756b" class="graf graf--h3 graf--leading">3. เขียนโปรแกรมสมองกลฝังตัวเพื่อรับและส่งค่าผ่าน MQTT</h3><figure name="183d" id="183d" class="graf graf--figure graf--iframe graf-after--h3"><iframe src="https://www.youtube.com/embed/2xZW4Wi88l0" width="700" height="393" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">การทดลอง 3 การเชื่อม ESP32 เข้ากับ MQTT Server และทดสอบ</figcaption></figure><p name="f9df" id="f9df" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">3.1 ติดตั้ง MQTT library</strong></p><p name="61ac" id="61ac" class="graf graf--p graf-after--p">MQTT จำเป็นต้องใช้ library ภายนอกเพิ่มเติม ซึ่งสามารถติดตั้งได้สะดวกผ่าน Library Manger ของ Arduino IDE ดังนี้</p><ul class="postList"><li name="e249" id="e249" class="graf graf--li graf-after--p">เลือกเมนู Tools / Manage Libraries …</li><li name="516e" id="516e" class="graf graf--li graf-after--li">พิมพ์ “MQTT Joel” ในช่องค้นหา</li><li name="cd93" id="cd93" class="graf graf--li graf-after--li">กดปุ่ม Install library ที่ชื่อ “MQTT by Joel Gaehwiler”</li></ul><blockquote name="59e8" id="59e8" class="graf graf--blockquote graf-after--li">Library สำหรับสื่อสารผ่าน MQTT ใน Arduino มาหลายตัวให้เลือก ในปฏิบัติการนี้เลือก library ชื่อ MQTT by Joel Gaehwiler (<a href="https://github.com/256dpi/arduino-mqtt" data-href="https://github.com/256dpi/arduino-mqtt" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">ดูคู่มือบน Github</a>)ข้างต้นเพราะค่อนข้างเป็นที่นิยม และการเขียนโปรแกรมเข้าใจได้ง่าย</blockquote><figure name="6243" id="6243" class="graf graf--figure graf-after--blockquote"><img class="graf-image" data-image-id="1*SXGso3EuxZfiubigtZdaKA.png" data-width="947" data-height="581" src="https://cdn-images-1.medium.com/max/800/1*SXGso3EuxZfiubigtZdaKA.png"><figcaption class="imageCaption">ภาพแสดงการติดตั้ง MQTT Library</figcaption></figure><p name="c59a" id="c59a" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">3.2 รวบรวมข้อมูลเกี่ยวกับ MQTT Broker</strong> เพื่อใช้ในโปรแกรม</p><p name="9a5b" id="9a5b" class="graf graf--p graf-after--p">ค่าที่เกี่ยวข้องกับการเชื่อมต่อ MQTT มีดังนี้</p><ul class="postList"><li name="1997" id="1997" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">ชื่อ MQTT Broker</strong> — จะใช้ Broker ตัวใด โดยในปฏิบัติการนี้จะใช้ <br>test.mosquitto.org<br>ซึ่งเป็น public broker เหมาะใช้กับการทดสอบ</li><li name="06bd" id="06bd" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Port ของ MQTT Broker</strong> — ขึ้นอยู่กับวิธีการเชื่อมต่อ และระดับความปลอดภัย โดยต่อไปนี้เป็นตัวอย่างเลข port ของ Broker ที่ชื่อ Mosquitto <br>- Port 1883 = Socket with no encryption<br>- Port 8883 = Socket with encryption<br>- Port 8080 = Web Socket with no encryption<br>- Port 8081 = Web Socket with encryption<br><a href="https://test.mosquitto.org/" data-href="https://test.mosquitto.org/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">ดูข้อมูลเพิ่มเติม</a><br>ในกรณีของ ESP32 เราจะต่อผ่าน Socket แบบไม่ encrypt จึงใช้ port 1883</li><li name="0208" id="0208" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">MQTT Topic ที่จะใช้ </strong>— ต้นทางและปลายทางต้องใช้ Topic เดียวกัน เช่นในปฏิบัติการนี้แนะนำให้ใช้<br>groupX/command<br>โดย X = เลขกลุ่ม</li></ul><p name="104c" id="104c" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">3.3 ทดลองเขียนโปรแกรม</strong> เพื่อให้ ESP32 สามารถ Publish และ Subscribe MQTT ได้</p><p name="4d51" id="4d51" class="graf graf--p graf-after--p">ให้ลองใช้ และทำความเข้าใจโปรแกรมตัวอย่างต่อไปนี้</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="cpp" name="70c2" id="70c2" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><br /><span class="hljs-comment">// Exmaple of using the MQTT library for ESP32 </span><br /><span class="hljs-comment">// Library by Joël Gähwiler</span><br /><span class="hljs-comment">// https://github.com/256dpi/arduino-mqtt</span><br /><span class="hljs-comment">// Modified by Arnan Sipitakiat</span><br /><br /><br /><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;WiFi.h&gt;</span></span><br /><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;MQTT.h&gt;</span></span><br /><br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> ssid[] = <span class="hljs-string">&quot;SSID&quot;</span>;<br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> pass[] = <span class="hljs-string">&quot;WIFI_PASSWORD&quot;</span>;<br /><br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> mqtt_broker[]=<span class="hljs-string">&quot;test.mosquitto.org&quot;</span>;<br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> mqtt_topic[]=<span class="hljs-string">&quot;group/command&quot;</span>;<br /><span class="hljs-type">const</span> <span class="hljs-type">char</span> mqtt_client_id[]=<span class="hljs-string">&quot;arduino_group_x&quot;</span>; <span class="hljs-comment">// must change this string to a unique value</span><br /><span class="hljs-type">int</span> MQTT_PORT=<span class="hljs-number">1883</span>;<br /><br /><span class="hljs-type">int</span> counter=<span class="hljs-number">0</span>;<br /><br />WiFiClient net;<br />MQTTClient client;<br /><br /><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> lastMillis = <span class="hljs-number">0</span>;<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> </span>{<br />  Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;checking wifi...&quot;</span>);<br />  <span class="hljs-keyword">while</span> (WiFi.<span class="hljs-built_in">status</span>() != WL_CONNECTED) {<br />    Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;.&quot;</span>);<br />    <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>);<br />  }<br /><br />  Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nconnecting...&quot;</span>);<br />  <span class="hljs-keyword">while</span> (!client.<span class="hljs-built_in">connect</span>(mqtt_client_id)) {  <br />    Serial.<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;.&quot;</span>);<br />    <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>);<br />  }<br /><br />  Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;\nconnected!&quot;</span>);<br /><br />  client.<span class="hljs-built_in">subscribe</span>(mqtt_topic);<br />  <span class="hljs-comment">// client.unsubscribe(&quot;/hello&quot;);</span><br />}<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">messageReceived</span><span class="hljs-params">(String &amp;topic, String &amp;payload)</span> </span>{<br />  Serial.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;incoming: &quot;</span> + topic + <span class="hljs-string">&quot; - &quot;</span> + payload);<br /><br />  <span class="hljs-comment">// Note: Do not use the client in the callback to publish, subscribe or</span><br />  <span class="hljs-comment">// unsubscribe as it may cause deadlocks when other things arrive while</span><br />  <span class="hljs-comment">// sending and receiving acknowledgments. Instead, change a global variable,</span><br />  <span class="hljs-comment">// or push to a queue and handle it in the loop after calling `client.loop()`.</span><br />}<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<br />  Serial.<span class="hljs-built_in">begin</span>(<span class="hljs-number">9600</span>);<br />  WiFi.<span class="hljs-built_in">begin</span>(ssid, pass);<br /><br />  <span class="hljs-comment">// Note: Local domain names (e.g. &quot;Computer.local&quot; on OSX) are not supported</span><br />  <span class="hljs-comment">// by Arduino. You need to set the IP address directly.</span><br />  client.<span class="hljs-built_in">begin</span>(mqtt_broker, MQTT_PORT, net);<br />  client.<span class="hljs-built_in">onMessage</span>(messageReceived);<br /><br />  <span class="hljs-built_in">connect</span>();<br />}<br /><br /><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<br />  client.<span class="hljs-built_in">loop</span>();<br />  <span class="hljs-built_in">delay</span>(<span class="hljs-number">10</span>);  <span class="hljs-comment">// &lt;- fixes some issues with WiFi stability</span><br /><br />  <span class="hljs-keyword">if</span> (!client.<span class="hljs-built_in">connected</span>()) {<br />    <span class="hljs-built_in">connect</span>();<br />  }<br /><br />  <span class="hljs-comment">// publish a message roughly every second.</span><br />  <span class="hljs-comment">// not that we don&#x27;t use delay() because we need to keep calling the client.loop()</span><br />  <span class="hljs-comment">// to keep the connection alive</span><br />  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">millis</span>() - lastMillis &gt; <span class="hljs-number">2000</span>) {<br />    lastMillis = <span class="hljs-built_in">millis</span>();<br />    client.<span class="hljs-built_in">publish</span>(mqtt_topic, <span class="hljs-string">&quot;Counter = &quot;</span> + <span class="hljs-built_in">String</span>(counter++));<br />  }<br />}</span></pre><p name="aba1" id="aba1" class="graf graf--p graf-after--pre">ตัวอย่างนี้ทำการ subscribe และ publish ไปยัง Topic เดียวกัน ดังนั้น ใน Serial Monitor ควรจะเห็นข้อความที่ Publish ปรากฏ ซึ่งในที่นี้คือคำว่า “Counter = X” โดย X เป็นจำนวนเต็มที่เพิ่มค่าขึ้นเรื่อย ๆ</p><p name="fef7" id="fef7" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">3.4 การทดลอง</strong></p><p name="a85f" id="a85f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">A. รายงานสถานะปุ่ม</strong></p><p name="3bc3" id="3bc3" class="graf graf--p graf-after--p">ให้ต่อปุ่มกดเข้ากับขาของ ESP32 แล้วเขียนโปรแกรมเพื่อส่งสถานะการกดปุ่มนี้ไปยัง MQTT โดยใช้ Web Client ดูค่า</p><ul class="postList"><li name="3ef2" id="3ef2" class="graf graf--li graf-after--p">เมื่อกดปุ่ม — ให้ส่ง “Button Pressed”</li><li name="68e2" id="68e2" class="graf graf--li graf-after--li">เมื่อคลายปุ่ม — ให้ส่ง “Button Released”</li></ul><p name="883e" id="883e" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">B. ควบคุมไฟ LED</strong></p><p name="3537" id="3537" class="graf graf--p graf-after--p">ต่อไปให้ ต่อ LED เข้ากับขาของ ESP32 แล้วเขียนโปรแกรมเพื่อควบคุมการเปิด-ปิดไฟนั้นผ่าน Web Client</p><ul class="postList"><li name="1115" id="1115" class="graf graf--li graf-after--p">เมื่อส่งคำว่า “on” — ให้เปิด LED</li><li name="a2df" id="a2df" class="graf graf--li graf-after--li">เมื่อส่งคำว่า “off” — ให้ปิด LED</li></ul><blockquote name="6b9f" id="6b9f" class="graf graf--blockquote graf-after--li">การ compare string ใน Arduino จะใช้ == เช่น</blockquote><blockquote name="f3c1" id="f3c1" class="graf graf--blockquote graf-after--blockquote">if (stringOne == “this”)</blockquote><h3 name="c838" id="c838" class="graf graf--h3 graf-after--blockquote">ประเด็นการเรียนรู้</h3><ul class="postList"><li name="3ee2" id="3ee2" class="graf graf--li graf-after--h3">การเชื่อมต่อกับ MQTT ผ่าน Browser กับ Device จะใช้ Protocol ต่างกัน ถ้าเป็น Web จะต้องใช้ “Web Socket” ในขณะที่ Device จะใช้ “Socket” ซึ่งแต่ละโปรโตคอลมีรายละเอียดต่างกัน เช่นเลข Port ที่ใช้เป็นต้น</li><li name="fe73" id="fe73" class="graf graf--li graf-after--li">Library Arduino มีการใช้สิ่งที่เรียกว่า Call-back (ในปฏิบัติการคือฟังก์ชัน ชื่อ messageReceived) เพื่อใช้รับข้อความที่ subscribe ไว้ ขอให้ศึกษาการทำงานของ Call-back ให้ดี</li><li name="312a" id="312a" class="graf graf--li graf-after--li graf--trailing">ใน loop() จะต้องคอยเรียก client.loop(); อยู่เสมอ ๆ เพื่อรักษา Connection และตรวจสอบ Message ที่เข้ามา ดังนั้นใน loop() จะไม่สามารถใช้คำสั่ง delay() ได้ เพราะเป็นคำสั่งที่บล๊อกการทำงาน ส่งผลให้ client.loop() ไม่ถูกเรียก ดังนั้นในตัวอย่างจึงใช้การนับเวลาแทน (ผ่าน millis()) ขอให้ทำความเข้าใจเรื่องนี้ให้ดี</li></ul></div></div></section><section name="10fa" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="f689" id="f689" class="graf graf--h3 graf--leading">4. การสร้าง MQTT Dashboard</h3><figure name="e5af" id="e5af" class="graf graf--figure graf--iframe graf-after--h3"><iframe src="https://www.youtube.com/embed/_4zVNPEZI8g?feature=oembed" width="700" height="393" frameborder="0" scrolling="no"></iframe><figcaption class="imageCaption">การทดลอง 4 สร้าง MQTT Dashboard</figcaption></figure><p name="718b" id="718b" class="graf graf--p graf-after--figure">Dashboard เป็นเครื่องมือที่ทำให้การรับ-ส่งค่าผ่าน MQTT ทำได้สะดวกขึ้นผ่านการสร้าง UI โดยเครื่องมือสร้าง Dashboard มีให้เลือกใช้มากมายทั้งในรูปแบบของ API, Phone App, หรือ Desktop App ซึ่งในปฏิบัติการนี้เราจะเลือกใช้ Web Application ที่ชื่อ <a href="https://mqtttiles.flespi.io/" data-href="https://mqtttiles.flespi.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MQTT Tiles by Flespi </a>เพราะไม่ต้องติดตั้งโปรแกรมและใช้งานได้ง่าย แม้จะมีความสามารถทีจำกัดอยู่บ้างก็ตาม</p><p name="ed7e" id="ed7e" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">4.1 เข้าใช้งาน </strong><a href="https://mqtttiles.flespi.io/" data-href="https://mqtttiles.flespi.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">MQTT Tiles</strong></a><strong class="markup--strong markup--p-strong"> และเชื่อมต่อ MQTT</strong></p><div name="eb34" id="eb34" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://mqtttiles.flespi.io/" data-href="https://mqtttiles.flespi.io/" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://mqtttiles.flespi.io/"><strong class="markup--strong markup--mixtapeEmbed-strong">MQTT Tiles</strong><br><em class="markup--em markup--mixtapeEmbed-em">MQTT-based IoT dashboard visualization tool</em>mqtttiles.flespi.io</a><a href="https://mqtttiles.flespi.io/" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="29715c8d9f7d6ae04d3e67b59d774b95"></a></div><p name="1ba6" id="1ba6" class="graf graf--p graf-after--mixtapeEmbed">เมื่อเข้าไปยังหน้า web หลักแล้วให้เชื่อมต่อ MQTT Broker โดยกดปุ่ม Connections ด้านบนขวาของจอภาพ แล้วสร้าง connection ใหม่ตามรายละเอียดในตัวอย่างนี้</p><ul class="postList"><li name="b99c" id="b99c" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">MQTT Client name </strong>— ตั้งเป็นชื่อตามที่ต้องการ</li><li name="c607" id="c607" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Client ID</strong> — ใช้ค่าที่มีก็ได้ ถ้าจะแก้ต้องไม่ใช้ซ้ำกับค่าอื่นที่เคยใช้</li><li name="c010" id="c010" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Host </strong>— wss://test.mosquitto.org:8081</li><li name="a3e9" id="a3e9" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">User Name </strong>— ให้ลบออก <em class="markup--em markup--li-em">ถ้ามี User name จะ login ไม่สำเร็จ</em></li></ul><figure name="4b18" id="4b18" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*6tnzeEGeS7cv4F7OA15Upw.png" data-width="698" data-height="572" src="https://cdn-images-1.medium.com/max/800/1*6tnzeEGeS7cv4F7OA15Upw.png"></figure><blockquote name="65f7" id="65f7" class="graf graf--blockquote graf-after--figure">MQTT Tiles บังคับให้เชื่อมต่อกับ MQTT Broker ผ่าน Web Socket แบบ encrypted ซึ่งทำให้ต้องใช้ Port 8081 (<a href="https://test.mosquitto.org/" data-href="https://test.mosquitto.org/" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">ดูข้อมูล Port และการเชื่อมต่อแบบต่าง ๆ ของ Mosquitto เพิ่มเติมได้ที่นี่</a>)</blockquote><p name="ddb6" id="ddb6" class="graf graf--p graf-after--blockquote">เมื่อกดปุ่ม “UPDATE” ก็ควรจะเห็นสถานะการเชื่อมต่อสำเร็จ โดยแสดงเป็นสีเขียว</p><figure name="1376" id="1376" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ZSz-63q9CCzupRq0JC5hpQ.png" data-width="415" data-height="460" src="https://cdn-images-1.medium.com/max/800/1*ZSz-63q9CCzupRq0JC5hpQ.png"><figcaption class="imageCaption">แสดงตัวอย่างการเชื่อมต่อที่สำเร็จแล้ว</figcaption></figure><p name="3287" id="3287" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">4.2 ทดลองสร้าง Dashboard เพื่อแสดงค่าจาก ESP32</strong></p><p name="2c75" id="2c75" class="graf graf--p graf-after--p">กดปุ่ม + ที่มุมล่างขวาเพื่อสร้าง Dashboard ใหม่ ตั้งชื่อให้เรียบร้อย แล้วเปิด Dashboard นั้นขึ้นมา</p><p name="5fe8" id="5fe8" class="graf graf--p graf-after--p">Dashboard ยังว่างเปล่า ให้เพิ่ม Widget ชนิด Text เข้าไปเพื่อแสดงสถานะการกดปุ่มจากการทดลองก่อนหน้าดังนี้</p><figure name="c055" id="c055" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hXVJFIigPjG92HoxKPuvwA.png" data-width="702" data-height="835" src="https://cdn-images-1.medium.com/max/800/1*hXVJFIigPjG92HoxKPuvwA.png"></figure><ul class="postList"><li name="25b9" id="25b9" class="graf graf--li graf-after--figure">Name — ชื่อสามารถตั้งตามที่ต้องการได้</li><li name="3ade" id="3ade" class="graf graf--li graf-after--li">Topic — เมื่อ Add Topic แล้วให้กำหนด MQTT Topic ที่จะรับข้อมูลเพื่อแสดงผล</li></ul><p name="d8f5" id="d8f5" class="graf graf--p graf-after--li">เมื่อสร้าง Widget เสร็จ และส่งค่าจาก ESP32 ไปยัง Topic ทีกำหนดไว้ ก็จะเห็นข้อความจาก ESP32 ปรากฏดังตัวอย่างนี้</p><figure name="1be8" id="1be8" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*LvNXkUoNZQLaUlykTxe0cQ.png" data-width="491" data-height="411" src="https://cdn-images-1.medium.com/max/800/1*LvNXkUoNZQLaUlykTxe0cQ.png"><figcaption class="imageCaption">แสดงตัวอย่าง Widget ที่แสดงค่าจาก ESP32</figcaption></figure><p name="b8b2" id="b8b2" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">4.3 เพิ่ม Widget ควบคุมการทำงานของ ESP32</strong></p><p name="0505" id="0505" class="graf graf--p graf-after--p">ให้ลองเพิ่มปุ่มควบคุมการเปิด-ปิด LED</p><ul class="postList"><li name="d54a" id="d54a" class="graf graf--li graf-after--p">สร้างปุ่ม “Turn ON” เพื่อเปิด LED</li><li name="4780" id="4780" class="graf graf--li graf-after--li">สร้างปุ่ม “Turn OFF” เพื่อปิด LED</li></ul><p name="14f8" id="14f8" class="graf graf--p graf-after--li">ปุ่มจะทำการ publish ข้อความไปยัง MQTT ตามทีกำหนด ดังแสดงในตัวอย่างต่อไปนี้</p><figure name="fff6" id="fff6" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Som12n9piQfPX_ydLZnOnA.png" data-width="702" data-height="826" src="https://cdn-images-1.medium.com/max/800/1*Som12n9piQfPX_ydLZnOnA.png"><figcaption class="imageCaption">แสดงตัวอย่างการตั้งค่าปุ่มกด</figcaption></figure><p name="c526" id="c526" class="graf graf--p graf-after--figure">เมื่อสร้างปุ่มครบ 2 ปุ่มแล้ว ก็ควรสามารถควบคุม LED ได้</p><h3 name="6ac5" id="6ac5" class="graf graf--h3 graf-after--p">ประเด็นการเรียนรู้</h3><ul class="postList"><li name="8ad0" id="8ad0" class="graf graf--li graf-after--h3">MQTT Dashboard มีหลายยี่ห้อ ให้เลือกใช้ ตัวอย่างที่ใช้ในปฏิบัติการนี้เป็นเพียงตัวอย่างเดียว ตัวอย่างอื่นที่เป็นที่นิยมได้แก่ App Android ชื่อ “<a href="https://play.google.com/store/apps/details?id=snr.lab.iotmqttpanel.prod&amp;hl=en&amp;gl=US" data-href="https://play.google.com/store/apps/details?id=snr.lab.iotmqttpanel.prod&amp;hl=en&amp;gl=US" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">IoT MQTT Panel</a>” หรือ Framework สำหรับ Home Automation ชื่อ <a href="https://www.home-assistant.io/" data-href="https://www.home-assistant.io/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Home Assistant</a></li><li name="8c79" id="8c79" class="graf graf--li graf-after--li graf--trailing">Widget ที่แต่ละ platform มีให้ใช้จะแตกต่างกันไป ดังนั้นควรเลือก platform ที่ตอบความต้องการของงานให้เหมาะสม</li></ul></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@lil.eng.cmu" class="p-author h-card">Learning Inventions Laboratory</a> on <a href="https://medium.com/p/47633bb76e58"><time class="dt-published" datetime="2022-12-09T02:30:40.864Z">December 9, 2022</time></a>.</p><p><a href="https://medium.com/@lil.eng.cmu/%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B8%AA%E0%B8%B7%E0%B9%88%E0%B8%AD%E0%B8%AA%E0%B8%B2%E0%B8%A3%E0%B8%81%E0%B8%B1%E0%B8%9A%E0%B8%AA%E0%B8%A1%E0%B8%AD%E0%B8%87%E0%B8%81%E0%B8%A5%E0%B8%9D%E0%B8%B1%E0%B8%87%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%9C%E0%B9%88%E0%B8%B2%E0%B8%99-mqtt-47633bb76e58" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 25, 2025.</p></footer></article></body></html>